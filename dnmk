#!/bin/bash
touch .doing
mp=$1
tp=$2
if [[ "$tp" = "" ]]; then
    tp=$(basename "$mp")
fi
curl "$mp" 2>/dev/null | grep -oE '<a\s+href="[^"]+"' | grep -oE "https?://[^\"]+$tp[^\"]*chapter_[^\"]+" | sort -V | uniq |
while read -r purl; do
    chap=$(basename "$purl")
    if [[ ! -d "$chap" ]]; then
        echo  "$chap" > .doing
        mkdir -p "$chap"
        cd "$chap"
            touch .doing
            curl "$purl" |grep -oE '<img(\s+class="img_content"|)\s+src="[^"]*"' |grep -oE 'https?://[^"]+/[0-9]+\.[^/"]+' |mwget -c -i -
            rm .doing
        cd - >/dev/null
    else
        echo "Directory exists: $chap [Skipped]"
    fi
done
find . -type d -empty -delete
mv -f .doing .done
